name: Sync Requirements

on:
  push:
    paths:
      - 'requirements-dev.txt'
    branches: [master]
  workflow_dispatch:

jobs:
  sync-requirements:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      
      - name: Install base requirements
        run: pip install -r requirements-dev.txt
      
      - name: Generate documentation requirements
        run: python scripts/generate_docs_requirements.py
        
      - name: Generate frozen requirements  
        run: python scripts/freeze_requirements.py
        
      - name: Update conda environment
        run: python scripts/requirements_to_conda_env.py --name solarwindpy-20250404
        
      - name: Check for changes
        id: verify-changed-files
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Commit updated requirements
        if: steps.verify-changed-files.outputs.changed == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add docs/requirements.txt requirements.txt solarwindpy-20250404.yml
          git commit -m "chore: auto-sync requirements from requirements-dev.txt

          - Updated docs/requirements.txt with documentation dependencies
          - Updated requirements.txt with frozen versions
          - Updated conda environment file
          - Auto-generated from requirements-dev.txt changes
          
          Generated by sync-requirements workflow"
          git push