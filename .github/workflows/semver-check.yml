name: Semantic Version Validation

on:
  push:
    tags:
      - '*'  # Validate all tags
  pull_request:
    branches: [ master ]
    paths:
      - '.github/workflows/semver-check.yml'
      - '.claude/hooks/validate-tags.sh'
  workflow_dispatch:  # Allow manual testing

jobs:
  validate-version:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history for tag validation
      
      - name: Make validate-tags.sh executable
        run: chmod +x .claude/hooks/validate-tags.sh
      
      - name: Validate semantic version tags
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          echo "Validating tag: $TAG"
          ./.claude/hooks/validate-tags.sh "$TAG"
          
      - name: Test validation hook
        if: github.event_name != 'push' || !startsWith(github.ref, 'refs/tags/')
        run: |
          echo "Testing semantic version validation..."
          
          # Test valid tags
          echo "Testing valid release tags:"
          ./.claude/hooks/validate-tags.sh "v1.0.0" || exit 1
          ./.claude/hooks/validate-tags.sh "v0.1.0-rc1" || exit 1
          ./.claude/hooks/validate-tags.sh "v2.1.3-beta.2" || exit 1
          echo "✅ Valid tags passed"
          
          # Test invalid tags (should fail)
          echo "Testing invalid tags (expecting failures):"
          if ./.claude/hooks/validate-tags.sh "1.0.0" 2>/dev/null; then
            echo "❌ Invalid tag '1.0.0' incorrectly passed validation"
            exit 1
          fi
          if ./.claude/hooks/validate-tags.sh "claude/compaction/2025-08-20-35pct" 2>/dev/null; then
            echo "❌ Compaction tag incorrectly passed validation"
            exit 1
          fi
          echo "✅ Invalid tags correctly rejected"
          
          echo "✅ All validation tests passed"